{% extends 'base.html' %}

{% load humanize %}

{% block title %} | {{ listing.title }} {% endblock %}

{% block content %}
    <!-- Hero Section -->
    <section id="property-hero" class="position-relative">
        <div class="hero-image-container">
            <img src="{{ listing.photo_main.url }}" alt="{{ listing.title }}" class="hero-image">
            <div class="hero-overlay">
                <div class="container">
                    <div class="row align-items-center min-vh-50">
                        <div class="col-lg-8">
                            <div class="hero-content text-white">
                                <div class="mb-3">
                                    {% if listing.price and listing.listing_type != 'rent' %}
                                        <span class="badge badge-primary px-3 py-2">
                                            ${{ listing.price | intcomma }}
                                            {% if listing.listing_type == 'both' %} Sale{% endif %}
                                        </span>
                                    {% endif %}
                                    {% if listing.rent_price and listing.listing_type != 'sale' %}
                                        <span class="badge badge-success px-3 py-2 {% if listing.price %}ml-2{% endif %}">
                                            ${{ listing.rent_price | intcomma }}/mo
                                            {% if listing.listing_type == 'both' %} Rent{% endif %}
                                        </span>
                                    {% endif %}
                                    {% if listing.is_published %}
                                        <span class="badge badge-info ml-2">Available</span>
                                    {% endif %}
                                </div>
                                <h1 class="display-4 font-weight-bold mb-3">{{ listing.title }}</h1>
                                <p class="lead mb-0">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    {{ listing.city }}, {{ listing.state }} {{ listing.zipcode }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Breadcrumb -->
    <section class="bg-light py-3">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'pages:index' %}">
                            <i class="fas fa-home mr-1"></i>Home
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'listings:listings' %}">Properties</a>
                    </li>
                    <li class="breadcrumb-item active">{{ listing.title }}</li>
                </ol>
            </nav>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <!-- Main Content Column -->
                <div class="col-lg-8">
                    <!-- Quick Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <a href="{% url 'listings:listings' %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Properties
                        </a>
                        <div class="property-actions">
                            {% if user.is_authenticated %}
                                <button class="btn btn-outline-secondary mr-2 wishlist-btn-detail" 
                                        data-listing-id="{{ listing.id }}"
                                        title="Add to wishlist">
                                    <i class="far fa-heart mr-1"></i>
                                    <span class="wishlist-text">Save</span>
                                </button>
                            {% else %}
                                <a href="{% url 'accounts:login' %}" class="btn btn-outline-secondary mr-2" title="Login to save properties">
                                    <i class="far fa-heart mr-1"></i>Save
                                </a>
                            {% endif %}
                            <button class="btn btn-outline-secondary" onclick="shareProperty()">
                                <i class="fas fa-share-alt mr-1"></i>Share
                            </button>
                        </div>
                    </div>

                    <!-- Property Features Overview -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-primary mb-4">Property Overview</h3>
                            <div class="row">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="feature-box text-center p-3">
                                        <div class="feature-icon mb-2">
                                            <i class="fas fa-bed fa-2x text-primary"></i>
                                        </div>
                                        <h5 class="mb-1">{{ listing.bedrooms }}</h5>
                                        <small class="text-muted">Bedroom{{ listing.bedrooms|pluralize }}</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="feature-box text-center p-3">
                                        <div class="feature-icon mb-2">
                                            <i class="fas fa-bath fa-2x text-primary"></i>
                                        </div>
                                        <h5 class="mb-1">{{ listing.bathrooms }}</h5>
                                        <small class="text-muted">Bathroom{{ listing.bathrooms|pluralize }}</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="feature-box text-center p-3">
                                        <div class="feature-icon mb-2">
                                            <i class="fas fa-expand-arrows-alt fa-2x text-primary"></i>
                                        </div>
                                        <h5 class="mb-1">{{ listing.sqft | intcomma }}</h5>
                                        <small class="text-muted">Square Feet</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="feature-box text-center p-3">
                                        <div class="feature-icon mb-2">
                                            <i class="fas fa-car fa-2x text-primary"></i>
                                        </div>
                                        <h5 class="mb-1">{{ listing.garage }}</h5>
                                        <small class="text-muted">Garage Space{{ listing.garage|pluralize }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Gallery -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-primary mb-4">Photo Gallery</h3>
                            <div class="row">
                        {% if listing.photo_1 %}
                                    <div class="col-md-4 col-6 mb-3">
                                        <div class="gallery-item">
                                            <a href="{{ listing.photo_1.url }}" data-lightbox="property-gallery">
                                                <img src="{{ listing.photo_1.url }}" alt="Property Image" class="img-fluid">
                                </a>
                                        </div>
                            </div>
                        {% endif %}
                        {% if listing.photo_2 %}
                                    <div class="col-md-4 col-6 mb-3">
                                        <div class="gallery-item">
                                            <a href="{{ listing.photo_2.url }}" data-lightbox="property-gallery">
                                                <img src="{{ listing.photo_2.url }}" alt="Property Image" class="img-fluid">
                                </a>
                                        </div>
                            </div>
                        {% endif %}
                        {% if listing.photo_3 %}
                                    <div class="col-md-4 col-6 mb-3">
                                        <div class="gallery-item">
                                            <a href="{{ listing.photo_3.url }}" data-lightbox="property-gallery">
                                                <img src="{{ listing.photo_3.url }}" alt="Property Image" class="img-fluid">
                                </a>
                                        </div>
                            </div>
                        {% endif %}
                        {% if listing.photo_4 %}
                                    <div class="col-md-4 col-6 mb-3">
                                        <div class="gallery-item">
                                            <a href="{{ listing.photo_4.url }}" data-lightbox="property-gallery">
                                                <img src="{{ listing.photo_4.url }}" alt="Property Image" class="img-fluid">
                                </a>
                                        </div>
                            </div>
                        {% endif %}
                        {% if listing.photo_5 %}
                                    <div class="col-md-4 col-6 mb-3">
                                        <div class="gallery-item">
                                            <a href="{{ listing.photo_5.url }}" data-lightbox="property-gallery">
                                                <img src="{{ listing.photo_5.url }}" alt="Property Image" class="img-fluid">
                                </a>
                                        </div>
                            </div>
                        {% endif %}
                        {% if listing.photo_6 %}
                                    <div class="col-md-4 col-6 mb-3">
                                        <div class="gallery-item">
                                            <a href="{{ listing.photo_6.url }}" data-lightbox="property-gallery">
                                                <img src="{{ listing.photo_6.url }}" alt="Property Image" class="img-fluid">
                                </a>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Property Details -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-primary mb-4">Property Details</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">Property Information</h6>
                                    <div class="list-group list-group-flush mb-4">
                                        {% if listing.property_type %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-home text-primary mr-2"></i>Property Type</span>
                                            <strong>{{ listing.property_type|title }}</strong>
                                        </div>
                                        {% endif %}
                                        {% if listing.listing_type %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-tag text-primary mr-2"></i>Listing Type</span>
                                            <strong>
                                                {% if listing.listing_type == 'sale' %}For Sale
                                                {% elif listing.listing_type == 'rent' %}For Rent
                                                {% elif listing.listing_type == 'both' %}Sale or Rent
                                                {% else %}{{ listing.listing_type|title }}
                                                {% endif %}
                                            </strong>
                                        </div>
                                        {% endif %}
                                        {% if listing.year_built %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-calendar-alt text-primary mr-2"></i>Year Built</span>
                                            <strong>{{ listing.year_built }}</strong>
                                        </div>
                                        {% endif %}
                                        {% if listing.energy_rating %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-leaf text-primary mr-2"></i>Energy Rating</span>
                                            <strong class="badge badge-success">{{ listing.energy_rating }}</strong>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <h6 class="text-muted mb-3">Financial Information</h6>
                                    <div class="list-group list-group-flush mb-4">
                                        {% if listing.price and listing.listing_type != 'rent' %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-dollar-sign text-primary mr-2"></i>
                                                {% if listing.listing_type == 'both' %}Sale Price{% else %}Asking Price{% endif %}
                                            </span>
                                            <strong class="text-primary">${{ listing.price | intcomma }}</strong>
                                        </div>
                                        {% endif %}
                                        {% if listing.rent_price and listing.listing_type != 'sale' %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-calendar text-primary mr-2"></i>Monthly Rent</span>
                                            <strong class="text-success">${{ listing.rent_price | intcomma }}/month</strong>
                                        </div>
                                        {% endif %}
                                        {% if listing.deposit_amount %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-shield-alt text-primary mr-2"></i>Security Deposit</span>
                                            <strong>${{ listing.deposit_amount | intcomma }}</strong>
                                        </div>
                                        {% endif %}
                                        {% if listing.hoa_fee %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-building text-primary mr-2"></i>HOA Fee</span>
                                            <strong>${{ listing.hoa_fee | intcomma }}/month</strong>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <h6 class="text-muted mb-3">Interior Features</h6>
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-bed text-primary mr-2"></i>Bedrooms</span>
                                            <strong>{{ listing.bedrooms }}</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-bath text-primary mr-2"></i>Bathrooms</span>
                                            <strong>{{ listing.bathrooms }}</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">Property Size</h6>
                                    <div class="list-group list-group-flush mb-4">
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-expand-arrows-alt text-primary mr-2"></i>Square Feet</span>
                                            <strong>{{ listing.sqft | intcomma }} sq ft</strong>
                                        </div>
                                        {% if listing.lot_size %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-square text-primary mr-2"></i>Lot Size</span>
                                            <strong>{{ listing.lot_size }} Acres</strong>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <h6 class="text-muted mb-3">Additional Features</h6>
                                    <div class="list-group list-group-flush mb-4">
                                        {% if listing.garage %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-car text-primary mr-2"></i>Garage</span>
                                            <strong>{{ listing.garage }} Space{{ listing.garage|pluralize }}</strong>
                                        </div>
                                        {% endif %}
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-calendar text-primary mr-2"></i>Listed Date</span>
                                            <strong>{{ listing.list_date | date:"M d, Y" }}</strong>
                                        </div>
                                        {% if listing.virtual_tour_url %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-vr-cardboard text-primary mr-2"></i>Virtual Tour</span>
                                            <a href="{{ listing.virtual_tour_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-external-link-alt mr-1"></i>View Tour
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Features & Amenities -->
                    {% if listing.amenities.all %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-primary mb-4">
                                <i class="fas fa-star mr-2"></i>Features & Amenities
                            </h3>
                            <div class="amenities-display">
                                {% for amenity in listing.amenities.all %}
                                    <div class="amenity-badge">
                                        {% if amenity.icon %}
                                            <i class="fas fa-{{ amenity.icon }} mr-2"></i>
                                        {% else %}
                                            <i class="fas fa-check mr-2"></i>
                                        {% endif %}
                                        {{ amenity.name }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Description -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h3 class="card-title text-primary mb-4">Property Description</h3>
                            <div class="property-description">
                                <p>{{ listing.description | linebreaks }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Realtor Card -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body text-center">
                            <div class="realtor-avatar mb-3">
                                <img src="{{ listing.realtor.photo.url }}" alt="{{ listing.realtor }}" 
                                     class="rounded-circle" width="100" height="100" style="object-fit: cover;">
                            </div>
                            <h5 class="card-title mb-1">{{ listing.realtor }}</h5>
                            <p class="text-muted mb-3">Licensed Real Estate Agent</p>
                            
                            <button class="btn btn-primary btn-block mb-2" data-toggle="modal" data-target="#inquiryModal">
                                <i class="fas fa-envelope mr-2"></i>Make an Inquiry
                            </button>
                            <button class="btn btn-outline-primary btn-block">
                                <i class="fas fa-phone mr-2"></i>Call Agent
                            </button>
                        </div>
                    </div>

                    <!-- Quick Contact Form -->
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-primary mb-3">Quick Contact</h5>
                            <form>
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Your Name" required>
                                </div>
                                <div class="form-group">
                                    <input type="email" class="form-control" placeholder="Your Email" required>
                                </div>
                                <div class="form-group">
                                    <input type="tel" class="form-control" placeholder="Phone Number">
                                </div>
                                <div class="form-group">
                                    <textarea class="form-control" rows="3" placeholder="I'm interested in this property..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">
                                    Send Message
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Inquiry Modal -->
    <div class="modal fade" id="inquiryModal" tabindex="-1" role="dialog" aria-labelledby="inquiryModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary" id="inquiryModalLabel">
                        <i class="fas fa-envelope mr-2"></i>Make an Inquiry
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'contact' %}" method="POST">
                        {% csrf_token %}
                        {% if user.is_authenticated %}
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                        {% else %}
                            <input type="hidden" name="user_id" value="0">
                        {% endif %}
                        <input type="hidden" name="realtor_email" value="{{ listing.realtor.email }}">
                        <input type="hidden" name="listing_id" value="{{ listing.id }}">
                        
                        <div class="form-group">
                            <label for="property_name">Property:</label>
                            <input type="text" name="listing" class="form-control" value="{{ listing.title }}" readonly>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                        <div class="form-group">
                                    <label for="name">Full Name:</label>
                                    <input type="text" name="name" class="form-control" 
                                           {% if user.is_authenticated %}value="{{ user.first_name }} {{ user.last_name }}"{% endif %} 
                                           required>
                                </div>
                        </div>
                            <div class="col-md-6">
                        <div class="form-group">
                                    <label for="email">Email Address:</label>
                                    <input type="email" name="email" class="form-control" 
                                           {% if user.is_authenticated %}value="{{ user.email }}"{% endif %} 
                                           required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number:</label>
                            <input type="tel" name="phone" class="form-control" placeholder="(555) 123-4567">
                        </div>
                        
                        <div class="form-group">
                            <label for="message">Message:</label>
                            <textarea name="message" class="form-control" rows="4" 
                                      placeholder="I am interested in this property and would like more information..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                            <i class="fas fa-paper-plane mr-2"></i>Send Inquiry
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Styles -->
    <style>
        .hero-image-container {
            position: relative;
            height: 400px;
            overflow: hidden;
        }
        
        .hero-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6));
            display: flex;
            align-items: center;
        }
        
        .min-vh-50 {
            min-height: 400px;
        }
        
        .feature-box {
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .feature-box:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
        }
        
        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        
        .gallery-item img {
            height: 200px;
            object-fit: cover;
            width: 100%;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .list-group-item {
            border-left: none;
            border-right: none;
            padding: 0.75rem 0;
        }
        
        .list-group-item:first-child {
            border-top: none;
        }
        
        .list-group-item:last-child {
            border-bottom: none;
        }
        
        .property-description p {
            line-height: 1.6;
            color: #555;
        }
        
        .badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        /* Wishlist button styling */
        .wishlist-btn-detail {
            transition: all 0.3s ease;
            border-width: 2px !important;
        }
        
        .wishlist-btn-detail i {
            transition: all 0.3s ease;
        }

        .wishlist-btn-detail:hover,
        .wishlist-btn-detail:focus {
            border-color: #e91e63 !important;
            color: #e91e63 !important;
            transform: translateY(-1px);
        }

        .wishlist-btn-detail:hover i,
        .wishlist-btn-detail:focus i {
            color: #e91e63 !important;
        }

        .wishlist-btn-detail.active,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active {
            background-color: #e91e63 !important;
            border-color: #e91e63 !important;
            color: white !important;
            box-shadow: 0 4px 8px rgba(233, 30, 99, 0.3) !important;
        }

        .wishlist-btn-detail.active i,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active i {
            color: white !important;
            animation: heartBeat 0.6s ease-in-out;
        }

        .wishlist-btn-detail.active:hover,
        .wishlist-btn-detail.active:focus,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active:hover,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active:focus {
            background-color: #ad1457 !important;
            border-color: #ad1457 !important;
            color: white !important;
            transform: translateY(-1px);
        }

        .wishlist-btn-detail.active:hover i,
        .wishlist-btn-detail.active:focus i,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active:hover i,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active:focus i {
            color: white !important;
        }

        /* Override Bootstrap's focus states */
        .wishlist-btn-detail:focus,
        .wishlist-btn-detail.focus {
            box-shadow: 0 0 0 0.2rem rgba(233, 30, 99, 0.25) !important;
        }

        .wishlist-btn-detail.active:focus,
        .wishlist-btn-detail:not(:disabled):not(.disabled).active:focus {
            box-shadow: 0 0 0 0.2rem rgba(233, 30, 99, 0.25), 0 4px 8px rgba(233, 30, 99, 0.3) !important;
        }

        /* Heart beat animation */
        @keyframes heartBeat {
            0% {
                transform: scale(1);
            }
            20% {
                transform: scale(1.3);
            }
            40% {
                transform: scale(1);
            }
            60% {
                transform: scale(1.2);
            }
            80% {
                transform: scale(1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* Amenities display */
        .amenities-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .amenity-badge {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: #495057;
            transition: all 0.3s ease;
        }
        
        .amenity-badge:hover {
            background-color: #e9ecef;
            border-color: #d5a06a;
            color: #d5a06a;
            transform: translateY(-1px);
        }
        
        .amenity-badge i {
            color: #28a745;
        }
        
        /* Responsive amenities */
        @media (max-width: 768px) {
            .amenities-display {
                gap: 0.5rem;
            }
            
            .amenity-badge {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        
        /* Virtual tour button styling */
        .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }
        
        .badge-info {
            background-color: #17a2b8 !important;
        }
    </style>

    <!-- Wishlist & Share JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize wishlist button for detail page
            const wishlistBtn = document.querySelector('.wishlist-btn-detail');
            
            if (wishlistBtn) {
                const listingId = wishlistBtn.getAttribute('data-listing-id');
                
                // Check if property is already in wishlist
                fetch(`/wishlist/check/${listingId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.in_wishlist) {
                            wishlistBtn.classList.add('active');
                            wishlistBtn.title = 'Remove from wishlist';
                            wishlistBtn.querySelector('.wishlist-text').textContent = 'Saved';
                            // Change to filled heart
                            const heartIcon = wishlistBtn.querySelector('i');
                            if (heartIcon) {
                                heartIcon.className = 'fas fa-heart mr-1';
                            }
                        } else {
                            // Ensure outline heart for non-wishlisted items
                            const heartIcon = wishlistBtn.querySelector('i');
                            if (heartIcon) {
                                heartIcon.className = 'far fa-heart mr-1';
                            }
                        }
                    })
                    .catch(error => console.log('Error checking wishlist status:', error));
                
                // Handle wishlist button click
                wishlistBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const isActive = this.classList.contains('active');
                    const action = isActive ? 'remove' : 'add';
                    
                    fetch(`/wishlist/${action}/${listingId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const heartIcon = this.querySelector('i');
                            
                            if (action === 'add') {
                                this.classList.add('active');
                                this.title = 'Remove from wishlist';
                                this.querySelector('.wishlist-text').textContent = 'Saved';
                                // Change to filled heart
                                if (heartIcon) {
                                    heartIcon.className = 'fas fa-heart mr-1';
                                }
                                showNotification('Property added to your wishlist!', 'success');
                            } else {
                                this.classList.remove('active');
                                this.title = 'Add to wishlist';
                                this.querySelector('.wishlist-text').textContent = 'Save';
                                // Change to outline heart
                                if (heartIcon) {
                                    heartIcon.className = 'far fa-heart mr-1';
                                }
                                showNotification('Property removed from your wishlist!', 'info');
                            }
                        } else {
                            showNotification(data.message || 'Something went wrong. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Something went wrong. Please try again.', 'error');
                    });
                });
            }
        });

        // Share property function
        function shareProperty() {
            const propertyTitle = "{{ listing.title|escapejs }}";
            const propertyUrl = window.location.href;
            const shareText = `Check out this amazing property: ${propertyTitle}`;
            
            if (navigator.share) {
                // Use native Web Share API if available
                navigator.share({
                    title: propertyTitle,
                    text: shareText,
                    url: propertyUrl
                }).then(() => {
                    showNotification('Property shared successfully!', 'success');
                }).catch(error => {
                    console.log('Error sharing:', error);
                    fallbackShare(shareText, propertyUrl);
                });
            } else {
                fallbackShare(shareText, propertyUrl);
            }
        }
        
        function fallbackShare(text, url) {
            // Fallback to copying link to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Property link copied to clipboard!', 'success');
                }).catch(() => {
                    showManualShare(text, url);
                });
            } else {
                showManualShare(text, url);
            }
        }
        
        function showManualShare(text, url) {
            // Show share options modal or links
            const shareOptions = `
                <div class="share-options">
                    <h6>Share this property:</h6>
                    <div class="btn-group-vertical w-100">
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" 
                           target="_blank" class="btn btn-outline-primary mb-2">
                            <i class="fab fa-facebook mr-2"></i>Share on Facebook
                        </a>
                        <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}" 
                           target="_blank" class="btn btn-outline-info mb-2">
                            <i class="fab fa-twitter mr-2"></i>Share on Twitter
                        </a>
                        <a href="mailto:?subject=${encodeURIComponent('{{ listing.title|escapejs }}')}&body=${encodeURIComponent(text + ' ' + url)}" 
                           class="btn btn-outline-secondary mb-2">
                            <i class="fas fa-envelope mr-2"></i>Share via Email
                        </a>
                        <button onclick="copyToClipboard('${url}')" class="btn btn-outline-dark">
                            <i class="fas fa-copy mr-2"></i>Copy Link
                        </button>
                    </div>
                </div>
            `;
            
            // Create and show modal with share options
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Share Property</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${shareOptions}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            $(modal).modal('show');
            
            // Remove modal after it's hidden
            $(modal).on('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }
        
        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Link copied to clipboard!', 'success');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show notification-toast`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            
            // Add styles for positioning
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }
    </script>
{% endblock %}